extends Node2D
class_name Bullet

# =============================================================================
# Bullet.gd
# =============================================================================
# LONG DESCRIPTION:
# A simple projectile that moves in a straight line.
# 
# NETWORKING STRATEGY: Event-Based Replication
# - Server sends "bullet_fired" event ONCE when created
# - Both server and clients simulate the bullet identically (deterministic)
# - Server is authoritative for hit detection
# - Clients show visual-only bullets (effects, tracers)
#
# This is efficient: 1 network message per bullet instead of 60/sec updates
# =============================================================================

# Unique ID for this bullet (server assigns)
var bullet_id: int = 0

# Who fired this bullet
var owner_id: int = 0

# Physics
var velocity: Vector2 = Vector2.ZERO
var lifetime: float = 0.0

# Constants
const MAX_LIFETIME: float = 3.0  # Bullets despawn after 3 seconds
const BULLET_SPEED: float = 400.0
const BULLET_DAMAGE: float = 25.0

# Visual
var _sprite: Sprite2D

# Server-only: track for hit detection
var is_server_bullet: bool = false


# -----------------------------------------------------------------------------
# _ready()
# -----------------------------------------------------------------------------
func _ready() -> void:
	# Create simple visual (small yellow square)
	_sprite = Sprite2D.new()
	_sprite.texture = _create_bullet_texture()
	_sprite.modulate = Color.YELLOW
	add_child(_sprite)


# -----------------------------------------------------------------------------
# initialize(pos, direction, owner, is_server)
# -----------------------------------------------------------------------------
# PURPOSE:
# - Set up bullet initial state (position, velocity, owner)
# - Called immediately after instantiation
#
# PARAMETERS:
# - pos: starting position
# - direction: normalized aim vector
# - owner: peer_id of shooter
# - is_server: true if this is the authoritative server bullet
# -----------------------------------------------------------------------------
func initialize(pos: Vector2, direction: Vector2, owner: int, is_server: bool = false) -> void:
	global_position = pos
	velocity = direction.normalized() * BULLET_SPEED
	owner_id = owner
	is_server_bullet = is_server
	rotation = direction.angle()


# -----------------------------------------------------------------------------
# _physics_process(delta)
# -----------------------------------------------------------------------------
# PURPOSE:
# - Move bullet forward
# - Check lifetime and despawn if too old
# - Server: check for hits
# -----------------------------------------------------------------------------
func _physics_process(delta: float) -> void:
	# Move
	global_position += velocity * delta
	lifetime += delta
	
	# Despawn after max lifetime
	if lifetime > MAX_LIFETIME:
		queue_free()
		return
	
	# Server: check for player hits
	if is_server_bullet:
		_check_hit()


# -----------------------------------------------------------------------------
# _check_hit()
# -----------------------------------------------------------------------------
# PURPOSE:
# - Server-only: raycast to detect if bullet hit a player
# - If hit, deal damage and despawn bullet
# -----------------------------------------------------------------------------
func _check_hit() -> void:
	var space := get_world_2d().direct_space_state
	var query := PhysicsRayQueryParameters2D.create(
		global_position,
		global_position + velocity.normalized() * 10  # Check 10 units ahead
	)
	query.exclude = [self]
	query.collision_mask = 1  # Layer 1 = players
	
	var result := space.intersect_ray(query)
	if result and result.collider is Player:
		var hit_player: Player = result.collider as Player
		
		# Don't allow self-damage (optional, you can remove this)
		if hit_player.net_id == owner_id:
			return
		
		# Deal damage
		hit_player.take_damage(BULLET_DAMAGE, owner_id)
		
		# Despawn bullet
		queue_free()


# -----------------------------------------------------------------------------
# _create_bullet_texture()
# -----------------------------------------------------------------------------
# PURPOSE:
# - Create a tiny 4x4 pixel texture for the bullet visual
# -----------------------------------------------------------------------------
func _create_bullet_texture() -> Texture2D:
	var img := Image.create(4, 4, false, Image.FORMAT_RGBA8)
	img.fill(Color(1, 1, 1, 1))
	return ImageTexture.create_from_image(img)
